name: Deploy Docs to GitHub Pages

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The tag/version to deploy to GitHub Pages'
        required: true
        type: string

  workflow_call:
    inputs:
      version:
        description: 'The tag/version to deploy to GitHub Pages'
        required: true
        type: string

jobs:
  prepare-docs:
    uses: ./.github/workflows/prepare-docs.yml
    with:
      version: ${{ inputs.version }}

  deploy-to-pages:
    needs: prepare-docs
    runs-on: ubuntu-latest
    steps:
      - name: Download prepared docs
        uses: actions/download-artifact@v4
        with:
          name: packaged-docs-${{ inputs.version }}
          path: build/docs

      - name: Extract documentation for GitHub Pages
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          
          DOC_PATH="build/docs/${VERSION}-kdoc.tar.gz"
          
          echo "üì¶ Processing documentation for GitHub Pages deployment"
          
          # Verify the documentation file exists
          if [ ! -f "$DOC_PATH" ]; then
            echo "‚ùå Error: Documentation artifact not found!"
            echo "Expected: $DOC_PATH"
            echo "Available files in build/docs:"
            find build/docs -type f 2>/dev/null || echo "No build/docs directory found"
            exit 1
          fi
          
          echo "‚úÖ Found documentation artifact: $DOC_PATH"
          echo "üìä File size: $(du -h "$DOC_PATH" | cut -f1)"
          
          # Create a directory for extracted docs
          mkdir -p ./pages-docs
          
          # Extract the tar.gz file
          echo "üì§ Extracting documentation..."
          tar -xzf "$DOC_PATH" -C ./pages-docs
          
          # Verify extraction was successful
          if [ -z "$(ls -A ./pages-docs)" ]; then
            echo "‚ùå Error: Documentation extraction failed - directory is empty"
            exit 1
          fi
          
          # List contents to verify extraction
          echo "‚úÖ Successfully extracted documentation:"
          echo "üìÇ Contents of ./pages-docs:"
          ls -la ./pages-docs

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./pages-docs
          destination_dir: ${{ inputs.version }}
          keep_files: false
          enable_jekyll: false
