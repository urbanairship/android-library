name: Deploy Docs to GitHub Pages

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The tag/version to deploy to GitHub Pages'
        required: true
        type: string

  workflow_call:
    inputs:
      version:
        description: 'The tag/version to deploy to GitHub Pages'
        required: true
        type: string

  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/deploy-docs-to-pages.yml'
      - '.github/workflows/publish-docs.yml'
      - 'docs/**'
      - 'documentation/**'
      - '**/*.md'
      - 'build.gradle'
      - 'gradle/**'

jobs:
  prepare-docs:
    if: github.repository == 'urbanairship/android-library'
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: extract_version
        run: |
          set -euo pipefail
          
          # Determine version based on trigger type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For PRs, use pr-<number>-<short-sha>
            VERSION="pr-${{ github.event.number }}-${GITHUB_SHA:0:7}"
            echo "üìù Pull Request build - using version: $VERSION"
            echo "VERSION_DIR=pr-${{ github.event.number }}" >> $GITHUB_ENV
          else
            # For workflow_dispatch and workflow_call, use inputs.version
            VERSION="${{ env.VERSION }}"
            MAJOR_VERSION=$(echo "$VERSION" | cut -d. -f1)
            echo "üè∑Ô∏è Release/Manual build - using version: $VERSION"
            echo "VERSION_DIR=v$MAJOR_VERSION" >> $GITHUB_ENV
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download packaged docs artifacts
        id: download_docs
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: packaged-docs-${{ env.VERSION }}
          path: build/docs

      # Fallback to building if artifacts were not previously uploaded for the given version.
      # NOTE: All the steps below this point will be skipped if the download step succeeds.
      - name: Checkout repo to build docs
        if: ${{ steps.download_docs.outcome == 'failure' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || format('refs/tags/{0}', env.VERSION) }}

      - name: Setup Java Version
        if: ${{ steps.download_docs.outcome == 'failure' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        if: ${{ steps.download_docs.outcome == 'failure' }}
        uses: gradle/actions/setup-gradle@v3

      - name: Copy CI gradle.properties
        if: ${{ steps.download_docs.outcome == 'failure' }}
        run: |
          set -euo pipefail
          mkdir -p ~/.gradle
          cp .github/ci-gradle.properties ~/.gradle/gradle.properties

      - name: Verify Version (Gradle equality)
        if: ${{ steps.download_docs.outcome == 'failure' }}
        run: |
          set -euo pipefail
          ACTUAL_VERSION=$(./gradlew -q getVersion)
          if [[ "$ACTUAL_VERSION" != "$VERSION" ]]; then
            echo "‚ùå Version mismatch!"
            echo "Expected: $VERSION"
            echo "Actual:   $ACTUAL_VERSION"
            exit 1
          fi
          echo "‚úÖ Version verified: $VERSION"

      - name: Build docs packages
        if: ${{ steps.download_docs.outcome == 'failure' }}
        run: |
          set -euo pipefail
          ./gradlew packageDocs --stacktrace

      - name: Extract documentation for GitHub Pages
        run: |
          set -euo pipefail

          DOC_PATH="build/docs/${VERSION}-kdoc.tar.gz"

          # Check which method was used to obtain docs
          if [[ "${{ steps.download_docs.outcome }}" == "success" ]]; then
            echo "üì¶ Using pre-packaged docs artifacts from release workflow"
          else
            echo "üî® Using locally built docs (pre-packaged artifacts not available)"
          fi

          # Verify the documentation file exists
          if [ ! -f "$DOC_PATH" ]; then
            echo "‚ùå Error: Documentation artifact not found!"
            echo "Expected: $DOC_PATH"
            echo "Available files in build/docs:"
            find build/docs -type f 2>/dev/null || echo "No build/docs directory found"
            if [ -d build ]; then
              echo "Available files in build directory:"
              find build -name "*.tar.gz" -type f 2>/dev/null || echo "No tar.gz files found in build directory"
            fi
            exit 1
          fi
          
          echo "‚úÖ Found documentation artifact: $DOC_PATH"
          echo "üìä File size: $(du -h "$DOC_PATH" | cut -f1)"
          
          # Create a directory for extracted docs
          mkdir -p ./pages-docs
          
          # Extract the tar.gz file
          echo "üì§ Extracting documentation..."
          tar -xzf "$DOC_PATH" -C ./pages-docs
          
          # Verify extraction was successful
          if [ -z "$(ls -A ./pages-docs)" ]; then
            echo "‚ùå Error: Documentation extraction failed - directory is empty"
            exit 1
          fi
          
          # List contents to verify extraction
          echo "‚úÖ Successfully extracted documentation:"
          echo "üìÇ Contents of ./pages-docs:"
          ls -la ./pages-docs

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./pages-docs
          destination_dir: ${{ env.VERSION }}
          keep_files: true
          enable_jekyll: false
